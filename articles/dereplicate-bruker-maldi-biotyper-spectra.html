<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="maldipickr">
<title>Dereplicate Bruker MALDI Biotyper spectra • maldipickr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Dereplicate Bruker MALDI Biotyper spectra">
<meta property="og:description" content="maldipickr">
<meta property="og:image" content="https://clavellab.github.io/maldipickr/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">maldipickr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/dereplicate-bruker-maldi-biotyper-spectra.html">Dereplicate Bruker MALDI Biotyper spectra</a>
    <a class="dropdown-item" href="../articles/import-data-from-bruker-maldi-biotyper.html">Import data from Bruker MALDI Biotyper</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-news">News</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-news">
    <h6 class="dropdown-header" data-toc-skip>Releases</h6>
    <a class="dropdown-item" href="https://clavellab.github.io/maldipickr/news/index.html#maldipickr-130">Version 1.3.0</a>
    <a class="dropdown-item" href="https://clavellab.github.io/maldipickr/news/index.html#maldipickr-120">Version 1.2.0</a>
    <a class="dropdown-item" href="https://clavellab.github.io/maldipickr/news/index.html#maldipickr-111">Version 1.1.1</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../news/index.html">Changelog</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ClavelLab/maldipickr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Dereplicate Bruker MALDI Biotyper spectra</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ClavelLab/maldipickr/blob/HEAD/vignettes/dereplicate-bruker-maldi-biotyper-spectra.Rmd" class="external-link"><code>vignettes/dereplicate-bruker-maldi-biotyper-spectra.Rmd</code></a></small>
      <div class="d-none name"><code>dereplicate-bruker-maldi-biotyper-spectra.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ClavelLab/maldipickr" class="external-link">maldipickr</a></span><span class="op">)</span></span></code></pre></div>
<!-- WARNING - This vignette is generated by {fusen} from dev/dereplicate-spectra.Rmd: do not edit by hand -->
<p>Bacterial colony identification with the Bruker MALDI Biotyper is a
high-throughput method with the built-in tools, provided that the
selected bacteria belong to the internal database.</p>
<p>Scientific projects where the number of unknown bacteria is expected
to be high needs reference-free methods to be able to reduce the
redundancy of isolated bacterial colonies, a process called
<em>dereplication</em>.</p>
<p><a href="https://doi.org/10.3389/fmicb.2018.01294" class="external-link">Strejcek <em>et
al.</em> (2018)</a> proposed such a method by processing the spectra and
suggest similarity thresholds between spectra above which spectra, and
therefore the measured bacterial colonies, can be considered identical
at a given taxonomic rank. Their processing procedure is implemented in
the <a href="https://github.com/ClavelLab/maldipickr" class="external-link"><code>{maldipickr}</code></a>
package and illustrated in the following vignette.</p>
<p>In addition, we provide functions to enable the dereplication of
different batches of Bruker MALDI Biotyper runs and combine the results,
in order to be able to delineate the clusters from a common similarity
matrix.</p>
<p>More importantly, we provide a function to select a spectra to be
picked in each cluster, a process called <em>cherry-picking</em>,
depending on external metadata and potential out-groups to be excluded
for the current cherry-picking steps.</p>
<div class="section level2">
<h2 id="process-bruker-maldi-biotyper-spectra">Process Bruker MALDI Biotyper spectra<a class="anchor" aria-label="anchor" href="#process-bruker-maldi-biotyper-spectra"></a>
</h2>
<div class="section level3">
<h3 id="process-from-raw-spectra-to-peak-filtering">Process from raw spectra to peak filtering<a class="anchor" aria-label="anchor" href="#process-from-raw-spectra-to-peak-filtering"></a>
</h3>
<p>From the imported raw data from the Bruker MALDI Biotyper, the
processing of the spectra is based on the original implementation, and
run the following tasks:</p>
<ol style="list-style-type: decimal">
<li>Square-root transformation</li>
<li>Mass range trimming to 4-10 kDa as they were deemed most determinant
by Strejcek et al. (2018)</li>
<li>Signal smoothing using the Savitzky-Golay method and a half window
size of 20</li>
<li>Baseline correction with the SNIP procedure</li>
<li>Normalization by Total Ion Current</li>
<li>Peak detection using the SuperSmoother procedure and with a
signal-to-noise ratio above 3</li>
<li>Peak filtering. This step has been added to discard peaks with a
negative signal-to-noise ratio probably due to being on the edge of the
mass range.</li>
</ol>
<p>The full procedure is illustrated in the example below. While in this
case, all the resulting processed spectra, peaks and final spectra
metadata are stored in-memory, the <a href="https://clavellab.github.io/maldipickr/reference/process_spectra.html"><code>process_spectra()</code></a>
function enables storing these files locally for scalable
high-throughput analyses.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get an example directory of six Bruker MALDI Biotyper spectra</span></span>
<span><span class="va">directory_biotyper_spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>  <span class="st">"toy-species-spectra"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"maldipickr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Import the six spectra</span></span>
<span><span class="va">spectra_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_biotyper_spectra.html">import_biotyper_spectra</a></span><span class="op">(</span><span class="va">directory_biotyper_spectra</span><span class="op">)</span></span>
<span><span class="co"># Transform the spectra signals according to Strejcek et al. (2018)</span></span>
<span><span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_spectra.html">process_spectra</a></span><span class="op">(</span><span class="va">spectra_list</span><span class="op">)</span></span>
<span><span class="co"># Overview of the list architecture that is returned</span></span>
<span><span class="co">#  with the list of processed spectra, peaks identified and the</span></span>
<span><span class="co">#  metadata table</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">processed</span>, max.level <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span><span class="co">#&gt; List of 3</span></span>
<span><span class="co">#&gt;  $ spectra :List of 6</span></span>
<span><span class="co">#&gt;   ..$ species1_G2 :Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;   ..$ species2_E11:Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;   ..$ species2_E12:Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F7 :Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F8 :Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F9 :Formal class 'MassSpectrum' [package "MALDIquant"] with 3 slots</span></span>
<span><span class="co">#&gt;  $ peaks   :List of 6</span></span>
<span><span class="co">#&gt;   ..$ species1_G2 :Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..$ species2_E11:Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..$ species2_E12:Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F7 :Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F8 :Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;   ..$ species3_F9 :Formal class 'MassPeaks' [package "MALDIquant"] with 4 slots</span></span>
<span><span class="co">#&gt;  $ metadata: tibble [6 × 3] (S3: tbl_df/tbl/data.frame)</span></span>
<span><span class="co"># A detailed view of the metadata with the median signal-to-noise</span></span>
<span><span class="co">#  ratio (SNR) and the number of peaks</span></span>
<span><span class="va">processed</span><span class="op">$</span><span class="va">metadata</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   name           SNR peaks</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2   5.09    21</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11  5.54    22</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12  5.63    23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7   4.89    26</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8   5.56    25</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9   5.40    25</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="merge-multiple-processed-spectra">Merge multiple processed spectra<a class="anchor" aria-label="anchor" href="#merge-multiple-processed-spectra"></a>
</h3>
<p>During high-throughput analyses, multiples runs of Bruker MALDI
Biotyper are expected resulting in several batches of spectra to be
processed and compared. While their processing is natively independent,
and could natively be run in parallel, the integration of the batches
for their comparison needs an additional step.</p>
<p>The <a href="https://clavellab.github.io/maldipickr/reference/merge_processed_spectra.html"><code>merge_processed_spectra()</code></a>
function aggregates the processed spectra and bins together the detected
peaks, with a tolerance of <span class="math inline">\(0.002\)</span>
between the average peak values in the bin (see <a href="https://rdrr.io/cran/MALDIquant/man/binPeaks-functions.html" class="external-link"><code>MALDIquant::binPeaks</code></a>),
which translate to a tolerance of 2000 ppm. This binning step results in
a <span class="math inline">\(n\times p\)</span> feature matrix (or
intensity matrix), with <span class="math inline">\(n\)</span> rows for
<span class="math inline">\(n\)</span> processed spectra (peak-less
spectra are discarded) and <span class="math inline">\(p\)</span>
columns for the <span class="math inline">\(p\)</span> peaks masses.</p>
<p>By default, as in the Strejeck et al. (2018) procedure, the intensity
values for spectra with missing peaks are interpolated from the
processed spectra signal. The current function enables the analyst to
decide whether to interpolate the values or leave missing peaks as
<code>NA</code> which would then be converted to an null intensity
value.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get an example directory of six Bruker MALDI Biotyper spectra</span></span>
<span><span class="va">directory_biotyper_spectra</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>  <span class="st">"toy-species-spectra"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"maldipickr"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Import the six spectra</span></span>
<span><span class="va">spectra_list</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/import_biotyper_spectra.html">import_biotyper_spectra</a></span><span class="op">(</span><span class="va">directory_biotyper_spectra</span><span class="op">)</span></span>
<span><span class="co"># Transform the spectra signals according to Strejcek et al. (2018)</span></span>
<span><span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/process_spectra.html">process_spectra</a></span><span class="op">(</span><span class="va">spectra_list</span><span class="op">)</span></span>
<span><span class="co"># Merge the spectra to produce the feature matrix</span></span>
<span><span class="va">fm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_processed_spectra.html">merge_processed_spectra</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">processed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The feature matrix has 6 spectra as rows and</span></span>
<span><span class="co">#  35 peaks as columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1]  6 35</span></span>
<span><span class="co"># Notice the difference when the interpolation is turned off</span></span>
<span><span class="va">fm_no_interpolation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_processed_spectra.html">merge_processed_spectra</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">processed</span><span class="op">)</span>,</span>
<span>  interpolate_missing <span class="op">=</span> <span class="cn">FALSE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">fm</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># 0</span></span>
<span><span class="co">#&gt; [1] 0</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">fm_no_interpolation</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="co"># 68</span></span>
<span><span class="co">#&gt; [1] 68</span></span>
<span></span>
<span><span class="co"># Multiple runs can be aggregated using list()</span></span>
<span><span class="co"># Merge the spectra to produce the feature matrix</span></span>
<span><span class="va">fm_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/merge_processed_spectra.html">merge_processed_spectra</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">processed</span>, <span class="va">processed</span>, <span class="va">processed</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># The feature matrix has 3×6=18 spectra as rows and</span></span>
<span><span class="co">#  35 peaks as columns</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">fm_all</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 18 35</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="compute-a-similarity-matrix-between-all-processed-spectra-not-included">Compute a similarity matrix between all processed spectra (not
included)<a class="anchor" aria-label="anchor" href="#compute-a-similarity-matrix-between-all-processed-spectra-not-included"></a>
</h3>
<p>Once all the batches of spectra have been processed together, we can
use a distance metric to evaluate how close the spectra are to one
another. <a href="https://doi.org/10.3389/fmicb.2018.01294" class="external-link">Strejcek
<em>et al.</em> (2018)</a> recommend the <em>cosine</em> metric to
compare the spectra and they use the fast implementation in the <a href="https://cran.r-project.org/package=coop" class="external-link"><code>{coop}</code></a>
package.</p>
<p>While we do not provide specific functions to generate the similarity
matrix, we illustrate below how it can be easily computed. Note that the
feature matrix from <a href="https://clavellab.github.io/maldipickr/reference/merge_processed_spectra.html"><code>merge_processed_spectra()</code></a>
has spectra as rows and peaks values as columns. So to get a similarity
matrix between spectra, either the feature matrix must be transposed or
a dedicated function must be used.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># A. Compute the similarity matrix on the transposed feature matrix</span></span>
<span><span class="co">#   using Pearson correlation coefficient</span></span>
<span><span class="va">sim_matrix</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">fm</span><span class="op">)</span>, method <span class="op">=</span> <span class="st">"pearson"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># B.1 Install the coop package</span></span>
<span><span class="co"># install.packages("coop")</span></span>
<span></span>
<span><span class="co"># B.2 Compute the similarity matrix on the rows of the feature matrix</span></span>
<span><span class="va">sim_matrix</span> <span class="op">&lt;-</span> <span class="fu">coop</span><span class="fu">::</span><span class="fu">tcosine</span><span class="op">(</span><span class="va">fm</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="delineate-clusters-of-spectra">Delineate clusters of spectra<a class="anchor" aria-label="anchor" href="#delineate-clusters-of-spectra"></a>
</h2>
<div class="section level3">
<h3 id="from-a-similarity-matrix">From a similarity matrix<a class="anchor" aria-label="anchor" href="#from-a-similarity-matrix"></a>
</h3>
<div class="section level4">
<h4 id="similarity-to-clusters">Similarity to clusters<a class="anchor" aria-label="anchor" href="#similarity-to-clusters"></a>
</h4>
<p>When the similarity matrix is computed between all pairs of the
studied spectra, the next step is to delineate clusters of spectra in
order to dereplicate the measured bacterial colonies, that is to find
which are nearly identical colonies.</p>
<p>The <a href="https://clavellab.github.io/maldipickr/reference/delineate_with_similarity.html"><code>delineate_with_similarity()</code></a>
is agnostic of the similarity metric used provided that the upper bound
is one and that a numeric threshold relevant to the metric used is
given. We recommend the cosine metric or the Pearson product moment.</p>
<p>Hierarchical clustering will then group spectra in the same cluster
only if the similarity between the spectra is <strong>above</strong> (or
<strong>equal to</strong>) the provided threshold. The default and
recommended method is the <em>complete linkage</em>, also known as the
farthest neighbor, to ensure that the within-group minimum similarity of
each cluster respects the threshold.</p>
<p>Finally, a table summarizes for each spectra, to which cluster number
it was assigned to and the size of the cluster, which is the total
number of spectra in the cluster.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Toy similarity matrix between the six example spectra of</span></span>
<span><span class="co">#  three species. The cosine metric is used and a value of</span></span>
<span><span class="co">#  zero indicates dissimilar spectra and a value of one</span></span>
<span><span class="co">#  indicates identical spectra.</span></span>
<span><span class="va">cosine_similarity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span>, <span class="fl">0.79</span>, <span class="fl">0.77</span>, <span class="fl">0.99</span>, <span class="fl">0.98</span>, <span class="fl">0.98</span>,</span>
<span>    <span class="fl">0.79</span>, <span class="fl">1</span>, <span class="fl">0.98</span>, <span class="fl">0.79</span>, <span class="fl">0.8</span>, <span class="fl">0.8</span>,</span>
<span>    <span class="fl">0.77</span>, <span class="fl">0.98</span>, <span class="fl">1</span>, <span class="fl">0.77</span>, <span class="fl">0.77</span>, <span class="fl">0.77</span>,</span>
<span>    <span class="fl">0.99</span>, <span class="fl">0.79</span>, <span class="fl">0.77</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.99</span>,</span>
<span>    <span class="fl">0.98</span>, <span class="fl">0.8</span>, <span class="fl">0.77</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>    <span class="fl">0.98</span>, <span class="fl">0.8</span>, <span class="fl">0.77</span>, <span class="fl">0.99</span>, <span class="fl">1</span>, <span class="fl">1</span></span>
<span>  <span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"species1_G2"</span>, <span class="st">"species2_E11"</span>, <span class="st">"species2_E12"</span>,</span>
<span>      <span class="st">"species3_F7"</span>, <span class="st">"species3_F8"</span>, <span class="st">"species3_F9"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"species1_G2"</span>, <span class="st">"species2_E11"</span>, <span class="st">"species2_E12"</span>,</span>
<span>      <span class="st">"species3_F7"</span>, <span class="st">"species3_F8"</span>, <span class="st">"species3_F9"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Delineate clusters based on a 0.92 threshold applied</span></span>
<span><span class="co">#  to the similarity matrix</span></span>
<span><span class="fu"><a href="../reference/delineate_with_similarity.html">delineate_with_similarity</a></span><span class="op">(</span><span class="va">cosine_similarity</span>, threshold <span class="op">=</span> <span class="fl">0.92</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;   name         membership cluster_size</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2           1            4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11          2            2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12          2            2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7           1            4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8           1            4</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9           1            4</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="set-a-reference-spectrum-for-each-cluster">Set a reference spectrum for each cluster<a class="anchor" aria-label="anchor" href="#set-a-reference-spectrum-for-each-cluster"></a>
</h4>
<p>Once the table of clusters is generated from the similarity matrix, a
reference spectrum can be assigned to each cluster.</p>
<p>We choose to define high-quality spectra as representative spectra of
the clusters using internal information. That is, representative spectra
have, within their cluster, the highest median signal-to-noise ratio and
then the highest number of detected peaks.</p>
<p>The function <a href="https://clavellab.github.io/maldipickr/reference/set_reference_spectra.html"><code>set_reference_spectra()</code></a>
does not change the order of the cluster table but merely adds an
additional column <code>is_reference</code> to indicate whether the
corresponding spectrum is representative of the cluster.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Get an example directory of six Bruker MALDI Biotyper spectra</span></span>
<span><span class="co"># Import the six spectra and</span></span>
<span><span class="co"># Transform the spectra signals according to Strejcek et al. (2018)</span></span>
<span><span class="va">processed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span></span>
<span>  <span class="st">"toy-species-spectra"</span>,</span>
<span>  package <span class="op">=</span> <span class="st">"maldipickr"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/import_biotyper_spectra.html">import_biotyper_spectra</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/process_spectra.html">process_spectra</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Toy similarity matrix between the six example spectra of</span></span>
<span><span class="co">#  three species. The cosine metric is used and a value of</span></span>
<span><span class="co">#  zero indicates dissimilar spectra and a value of one</span></span>
<span><span class="co">#  indicates identical spectra.</span></span>
<span><span class="va">cosine_similarity</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fl">1</span>, <span class="fl">0.79</span>, <span class="fl">0.77</span>, <span class="fl">0.99</span>, <span class="fl">0.98</span>, <span class="fl">0.98</span>,</span>
<span>    <span class="fl">0.79</span>, <span class="fl">1</span>, <span class="fl">0.98</span>, <span class="fl">0.79</span>, <span class="fl">0.8</span>, <span class="fl">0.8</span>,</span>
<span>    <span class="fl">0.77</span>, <span class="fl">0.98</span>, <span class="fl">1</span>, <span class="fl">0.77</span>, <span class="fl">0.77</span>, <span class="fl">0.77</span>,</span>
<span>    <span class="fl">0.99</span>, <span class="fl">0.79</span>, <span class="fl">0.77</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.99</span>,</span>
<span>    <span class="fl">0.98</span>, <span class="fl">0.8</span>, <span class="fl">0.77</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>,</span>
<span>    <span class="fl">0.98</span>, <span class="fl">0.8</span>, <span class="fl">0.77</span>, <span class="fl">0.99</span>, <span class="fl">1</span>, <span class="fl">1</span></span>
<span>  <span class="op">)</span>,</span>
<span>  nrow <span class="op">=</span> <span class="fl">6</span>,</span>
<span>  dimnames <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"species1_G2"</span>, <span class="st">"species2_E11"</span>, <span class="st">"species2_E12"</span>,</span>
<span>      <span class="st">"species3_F7"</span>, <span class="st">"species3_F8"</span>, <span class="st">"species3_F9"</span></span>
<span>    <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"species1_G2"</span>, <span class="st">"species2_E11"</span>, <span class="st">"species2_E12"</span>,</span>
<span>      <span class="st">"species3_F7"</span>, <span class="st">"species3_F8"</span>, <span class="st">"species3_F9"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Delineate clusters based on a 0.92 threshold applied</span></span>
<span><span class="co">#  to the similarity matrix</span></span>
<span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/delineate_with_similarity.html">delineate_with_similarity</a></span><span class="op">(</span></span>
<span>  <span class="va">cosine_similarity</span>,</span>
<span>  threshold <span class="op">=</span> <span class="fl">0.92</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Set reference spectra with the toy example</span></span>
<span><span class="fu"><a href="../reference/set_reference_spectra.html">set_reference_spectra</a></span><span class="op">(</span><span class="va">clusters</span>, <span class="va">processed</span><span class="op">$</span><span class="va">metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   name         membership cluster_size   SNR peaks is_reference</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2           1            4  5.09    21 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11          2            2  5.54    22 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12          2            2  5.63    23 TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7           1            4  4.89    26 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8           1            4  5.56    25 TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9           1            4  5.40    25 FALSE</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="from-taxonomic-identifications">From taxonomic identifications<a class="anchor" aria-label="anchor" href="#from-taxonomic-identifications"></a>
</h3>
<p>An alternative to the similarity matrix approach from the previous
section is to rely on the taxonomic identification of the spectra to
delineate clusters. To do so, we must use the Bruker MALDI Biotyper
report from the Compass software that summarize the identification of
the microorganisms using its internal database. Once the report or
reports are imported (in R using <a href="https://clavellab.github.io/maldipickr/reference/read_biotyper_report.html"><code>read_biotyper_report()</code></a>),
the function <a href="https://clavellab.github.io/maldipickr/reference/delineate_with_identification.html"><code>delineate_with_identification()</code></a>
will group spectra based on their identifications.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">report_unknown</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/read_biotyper_report.html">read_biotyper_report</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"biotyper_unknown.csv"</span>, package <span class="op">=</span> <span class="st">"maldipickr"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/delineate_with_identification.html">delineate_with_identification</a></span><span class="op">(</span><span class="va">report_unknown</span><span class="op">)</span></span>
<span><span class="co">#&gt; Generating clusters from single report</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   name              membership cluster_size</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> unknown_isolate_1          2            1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> unknown_isolate_2          3            1</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> unknown_isolate_3          1            2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> unknown_isolate_4          1            2</span></span></code></pre></div>
<p>Clusters generated from taxonomic identifications can not use the
function <a href="https://clavellab.github.io/maldipickr/reference/set_reference_spectra.html"><code>set_reference_spectra()</code></a>
as the latter relies on peaks information that is not disclosed in the
Biotyper report.</p>
<p>Therefore, users interested in cherry-picking spectra using taxonomic
identifications should use the <a href="https://clavellab.github.io/maldipickr/reference/pick_spectra.html"><code>pick_spectra()</code></a>
function described below with the combination of the input and output
tables of the <a href="https://clavellab.github.io/maldipickr/reference/delineate_with_identification.html"><code>delineate_with_identification()</code></a>
function to pick for instance spectra with the highest log score (using
<code>criteria_column = "bruker_log"</code>).</p>
</div>
<div class="section level3">
<h3 id="import-clusters-results-generated-by-spede">Import clusters results generated by SPeDE<a class="anchor" aria-label="anchor" href="#import-clusters-results-generated-by-spede"></a>
</h3>
<p>Raw spectra can also be processed and clustered by another approach,
named <a href="https://github.com/LM-UGent/SPeDE" class="external-link"><code>SPeDE</code></a>,
developed by Dumolin et al. (2019). The resulting dereplication step
produces a comma separated table. The example below illustrates how to
import this table into R to be consistent with the dereplication table
generated within the <a href="https://github.com/ClavelLab/maldipickr" class="external-link"><code>{maldipickr}</code></a>
package.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Reformat the output from SPeDE table</span></span>
<span><span class="co"># https://github.com/LM-UGent/SPeDE</span></span>
<span><span class="fu"><a href="../reference/import_spede_clusters.html">import_spede_clusters</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"spede.csv"</span>, package <span class="op">=</span> <span class="st">"maldipickr"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 5</span></span></span>
<span><span class="co">#&gt;   name         membership cluster_size quality is_reference</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2           1            1 GREEN   TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11          2            2 ORANGE  FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12          2            2 GREEN   TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7           3            1 GREEN   TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8           4            2 ORANGE  FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9           4            2 GREEN   TRUE</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="cherry-pick-bruker-maldi-biotyper-spectra">Cherry-pick Bruker MALDI Biotyper spectra<a class="anchor" aria-label="anchor" href="#cherry-pick-bruker-maldi-biotyper-spectra"></a>
</h2>
<p>When isolating bacteria from an environment, experimenters want to be
thorough but also work-, time- and cost-savvy. One approach is to reduce
the redundancy of the bacterial isolates by analyzing their MALDI-TOF
spectra from the Bruker Biotyper. All the steps previously described in
this vignette consisted of processing the spectra to be able to pick
only non-redundant spectra, using the <a href="https://clavellab.github.io/maldipickr/reference/pick_spectra.html"><code>pick_spectra()</code></a>
function.</p>
<p>The function, as illustrated in the examples below, can pick spectra
using different types of inputs:</p>
<ul>
<li>the reference spectra information that is present in the cluster
table (after using <a href="https://clavellab.github.io/maldipickr/reference/delineate_with_similarity.html"><code>delineate_with_similarity()</code></a>
or <a href="https://clavellab.github.io/maldipickr/reference/import_spede_clusters.html"><code>import_spede_clusters()</code></a>
functions; see example 1)</li>
<li>an external metadata table containing a variable (e.g., optical
density, fluorescence) to be maximized (default) or minimized per
cluster (see example 2)</li>
</ul>
<p>Spectra, and clusters, can also be excluded from the cherry-picking
decision, a procedure termed <em>masking</em> here. We distinguish two
types of mask that are implemented in the <a href="https://clavellab.github.io/maldipickr/reference/pick_spectra.html"><code>pick_spectra()</code></a>
function:</p>
<ul>
<li>
<strong>soft mask</strong> that discards the spectra only, if they
correspond for instance to low-quality sample, negative control samples
(see example 3)</li>
<li>
<strong>hard mask</strong> that discards the spectra <em>and their
clusters</em> (see example 4). This is particularly useful if some
spectra have been previously picked. For instance, to exclude colonies
grown and picked 24h after streaking when comparing with colonies grown
for 72h.</li>
</ul>
<p>Advanced users can also provide directly a cluster table with a
custom sort by cluster to accommodate complex design.</p>
<p>Ultimately, the function delivers a table with as many rows as the
cluster table with an additional logical column named
<code>to_pick</code> to indicate whether the colony associated with the
spectra should be picked (<code>TRUE</code>) or not picked
(<code>FALSE</code>).</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 0. Load a toy example of a tibble of clusters created by</span></span>
<span><span class="co">#   the `delineate_with_similarity` function.</span></span>
<span><span class="va">clusters</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"clusters_tibble.RDS"</span>,</span>
<span>    package <span class="op">=</span> <span class="st">"maldipickr"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 1. By default and if no other metadata are provided,</span></span>
<span><span class="co">#   the function picks reference spectra for each clusters.</span></span>
<span><span class="co">#</span></span>
<span><span class="co"># N.B: The spectra `name` and `to_pick` columns are moved to the left</span></span>
<span><span class="co"># only for clarity using the `relocate()` function.</span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="../reference/pick_spectra.html">pick_spectra</a></span><span class="op">(</span><span class="va">clusters</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">to_pick</span><span class="op">)</span> <span class="co"># only for clarity</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   name         to_pick membership cluster_size   SNR peaks is_reference</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2  FALSE            1            4  5.09    21 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11 FALSE            2            2  5.54    22 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12 TRUE             2            2  5.63    23 TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7  FALSE            1            4  4.89    26 FALSE       </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8  TRUE             1            4  5.56    25 TRUE        </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9  FALSE            1            4  5.40    25 FALSE</span></span>
<span></span>
<span><span class="co"># 2.1 Simulate OD600 values with uniform distribution</span></span>
<span><span class="co">#  for each of the colonies we measured with</span></span>
<span><span class="co">#  the Bruker MALDI Biotyper</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">104</span><span class="op">)</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/transmute.html" class="external-link">transmute</a></span><span class="op">(</span></span>
<span>  <span class="va">clusters</span>,</span>
<span>  name <span class="op">=</span> <span class="va">name</span>, OD600 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">clusters</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">metadata</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 2</span></span></span>
<span><span class="co">#&gt;   name         OD600</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2  0.364</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11 0.772</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12 0.735</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7  0.973</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8  0.740</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9  0.201</span></span>
<span></span>
<span><span class="co"># 2.2 Pick the spectra based on the highest</span></span>
<span><span class="co">#   OD600 value per cluster</span></span>
<span><span class="fu"><a href="../reference/pick_spectra.html">pick_spectra</a></span><span class="op">(</span><span class="va">clusters</span>, <span class="va">metadata</span>, <span class="st">"OD600"</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">to_pick</span><span class="op">)</span> <span class="co"># only for clarity</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 8</span></span></span>
<span><span class="co">#&gt;   name         to_pick membership cluster_size   SNR peaks is_reference OD600</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1_G2  FALSE            1            4  5.09    21 FALSE        0.364</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2_E11 TRUE             2            2  5.54    22 FALSE        0.772</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2_E12 FALSE            2            2  5.63    23 TRUE         0.735</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3_F7  TRUE             1            4  4.89    26 FALSE        0.973</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3_F8  FALSE            1            4  5.56    25 TRUE         0.740</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3_F9  FALSE            1            4  5.40    25 FALSE        0.201</span></span>
<span></span>
<span><span class="co"># 3.1 Say that the wells on the right side of the plate are</span></span>
<span><span class="co">#   used for negative controls and should not be picked.</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  well <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">".*[A-Z]([0-9]{1,2}$)"</span>, <span class="st">"\\1"</span>, <span class="va">name</span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/strtoi.html" class="external-link">strtoi</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  is_edge <span class="op">=</span> <span class="fu"><a href="../reference/is_well_on_edge.html">is_well_on_edge</a></span><span class="op">(</span></span>
<span>    well_number <span class="op">=</span> <span class="va">well</span>, plate_layout <span class="op">=</span> <span class="fl">96</span>, edges <span class="op">=</span> <span class="st">"right"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># 3.2 Pick the spectra after discarding (or soft masking)</span></span>
<span><span class="co">#   the spectra indicated by the `is_edge` column.</span></span>
<span><span class="fu"><a href="../reference/pick_spectra.html">pick_spectra</a></span><span class="op">(</span><span class="va">clusters</span>, <span class="va">metadata</span>, <span class="st">"OD600"</span>,</span>
<span>  soft_mask_column <span class="op">=</span> <span class="st">"is_edge"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">to_pick</span><span class="op">)</span> <span class="co"># only for clarity</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">#&gt;   name      to_pick membership cluster_size   SNR peaks is_reference OD600  well</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1… FALSE            1            4  5.09    21 FALSE        0.364     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2… TRUE             2            2  5.54    22 FALSE        0.772    11</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2… FALSE            2            2  5.63    23 TRUE         0.735    12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3… TRUE             1            4  4.89    26 FALSE        0.973     7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3… FALSE            1            4  5.56    25 TRUE         0.740     8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3… FALSE            1            4  5.40    25 FALSE        0.201     9</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 1 more variable: is_edge &lt;lgl&gt;</span></span></span>
<span></span>
<span><span class="co"># 4.1 Say that some spectra were picked before</span></span>
<span><span class="co">#   (e.g., in the column F) in a previous experiment.</span></span>
<span><span class="co"># We do not want to pick clusters with those spectra</span></span>
<span><span class="co">#   included to limit redundancy.</span></span>
<span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="va">metadata</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  picked_before <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"_F"</span>, <span class="va">name</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># 4.2 Pick the spectra from clusters without spectra</span></span>
<span><span class="co">#   labeled as `picked_before` (hard masking).</span></span>
<span><span class="fu"><a href="../reference/pick_spectra.html">pick_spectra</a></span><span class="op">(</span><span class="va">clusters</span>, <span class="va">metadata</span>, <span class="st">"OD600"</span>,</span>
<span>  hard_mask_column <span class="op">=</span> <span class="st">"picked_before"</span></span>
<span><span class="op">)</span> <span class="op"><a href="../reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/relocate.html" class="external-link">relocate</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">to_pick</span><span class="op">)</span> <span class="co"># only for clarity</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 11</span></span></span>
<span><span class="co">#&gt;   name      to_pick membership cluster_size   SNR peaks is_reference OD600  well</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> species1… FALSE            1            4  5.09    21 FALSE        0.364     2</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> species2… TRUE             2            2  5.54    22 FALSE        0.772    11</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> species2… FALSE            2            2  5.63    23 TRUE         0.735    12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> species3… FALSE            1            4  4.89    26 FALSE        0.973     7</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> species3… FALSE            1            4  5.56    25 TRUE         0.740     8</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> species3… FALSE            1            4  5.40    25 FALSE        0.201     9</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 2 more variables: is_edge &lt;lgl&gt;, picked_before &lt;lgl&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<ul>
<li>Dumolin C, Aerts M, Verheyde B, Schellaert S, Vandamme T, Van Der
Jeugt F, De Canck E, Cnockaert M, Wieme AD, Cleenwerck I, Peiren J,
Dawyndt P, Vandamme P, &amp; Carlier A. (2019). “Introducing SPeDE:
High-Throughput Dereplication and Accurate Determination of Microbial
Diversity from Matrix-Assisted Laser Desorption–Ionization Time of
Flight Mass Spectrometry Data”. <em>MSystems</em> 4(5). <a href="doi:10.1128/msystems.00437-19" class="uri">doi:10.1128/msystems.00437-19</a>.</li>
<li>Strejcek M, Smrhova T, Junkova P &amp; Uhlik O (2018). “Whole-Cell
MALDI-TOF MS versus 16S rRNA Gene Analysis for Identification and
Dereplication of Recurrent Bacterial Isolates.” <em>Frontiers in
Microbiology</em> 9 <a href="doi:10.3389/fmicb.2018.01294" class="uri">doi:10.3389/fmicb.2018.01294</a>.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Charlie Pauvert, Thomas Clavel.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
