---
title: "maldipickr Workflow with {targets}"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r development, include=FALSE}
library(testthat)
```

```{r development-load}
# Load already included functions if relevant
pkgload::load_all(export_all = FALSE)
```


Simultaneous bacterial isolation efforts require rapid dereplication of bacteria, if not their identification, to reduce the redundancy of isolates.

To this end,  the workhorse functions of [`{maldipickr}`](https://github.com/ClavelLab/maldipickr)
help import and then analyse MALDI-TOF spectra to dereplicate and cherry-pick mass spectrometry spectra.
The vignettes ["Import data from Bruker MALDI Biotyper"](https://clavellab.github.io/maldipickr/articles/import-data-from-bruker-maldi-biotyper.html) and ["Dereplicate Bruker MALDI Biotyper spectra"](https://clavellab.github.io/maldipickr/articles/dereplicate-bruker-maldi-biotyper-spectra.html) explain these functions in details if need be.


This vignette showcase functions to facilitate reproducible and trustworthy workflow development `{maldipickr}` (using [`{targets}`](https://docs.ropensci.org/targets/)). We invite readers unfamiliar with `{targets}` to read the short and well-written walkthrough ["How to use {targets}"](https://books.ropensci.org/targets/walkthrough.html) to understand how `{targets}` help analysts "coordinate the pieces of computationally demanding analysis projects" and "skips costly runtime for tasks that are already up to date" (source: <https://cran.r-project.org/package=targets>).


These helpers in `{maldipickr}` are called `{targets}` factories, which means they return target objects or lists of target objects. 



# tar_import_and_process_spectra
    
```{r function-tar_import_and_process_spectra}
#' Title
#' 
#' Description
#' 
#' @param name 
#' @param raw_spectra_directories 
#' @param tolerance 
#'
#' @return
#' 
#' @export
tar_import_and_process_spectra <- function(
    name,
    raw_spectra_directories,
    tolerance,
    format = targets::tar_option_get("format")) {
  rlang::check_installed(c("targets", "tarchetypes"),
    reason = "to facilitate {maldipickr} workflow development"
  )
  targets::tar_assert_chr(name)
  targets::tar_assert_path(raw_spectra_directories)
  targets::tar_assert_dbl(tolerance)

  name_plates <- paste0(name, "_plates")
  name_spectra_raw <- paste0(name, "_spectra_raw")
  name_checks <- paste0(name, "_checks")
  name_spectra_stats <- paste0(name, "_spectra_stats")
  name_valid_spectra <- paste0(name, "_valid_spectra")
  name_processed <- paste0(name, "_processed")

  sym_plates <- as.symbol(name_plates)
  sym_spectra_raw <- as.symbol(name_spectra_raw)
  sym_checks <- as.symbol(name_checks)
  sym_spectra_stats <- as.symbol(name_spectra_stats)
  sym_valid_spectra <- as.symbol(name_valid_spectra)

  list(
    tarchetypes::tar_files_input_raw(name_plates,
      raw_spectra_directories,
      format = "file"
    ),
    targets::tar_target_raw(name_spectra_raw,
      command = substitute(suppressWarnings(import_biotyper_spectra(sym_plates)),
        env = list(sym_plates = sym_plates)
      ),
      pattern = substitute(map(sym_plates),
        env = list(sym_plates = sym_plates)
      ),
      format = format
    ),
    targets::tar_target_raw(name_checks,
      command = substitute(check_spectra(sym_spectra_raw, tolerance),
        env = list(tolerance = tolerance, sym_spectra_raw = sym_spectra_raw)
      ),
      pattern = substitute(map(sym_spectra_raw), env = list(sym_spectra_raw = sym_spectra_raw)),
      format = format
    ),
    targets::tar_target_raw(name_spectra_stats,
      command = substitute(
        gather_spectra_stats(sym_checks) %>%
          dplyr::mutate(maldi_plate = sym_plates),
        env = list(sym_checks = sym_checks, sym_plates = sym_plates)
      ),
      pattern = substitute(map(sym_checks, sym_plates),
        env = list(sym_checks = sym_checks, sym_plates = sym_plates)
      ),
      iteration = "vector", format = format
    ),
    # Filter-out non empty spectra and unusual spectra
    targets::tar_target_raw(name_valid_spectra,
      command = substitute(remove_spectra(sym_spectra_raw, sym_checks),
        env = list(sym_spectra_raw = sym_spectra_raw, sym_checks = sym_checks)
      ),
      pattern = substitute(map(sym_spectra_raw, sym_checks),
        env = list(sym_spectra_raw = sym_spectra_raw, sym_checks = sym_checks)
      ),
      format = format
    ),
    targets::tar_target_raw(name_processed,
      command = substitute(process_spectra(sym_valid_spectra),
        env = list(sym_valid_spectra = sym_valid_spectra)
      ),
      pattern = substitute(map(sym_valid_spectra),
        env = list(sym_valid_spectra = sym_valid_spectra)
      ),
      format = format
    )
  )
}
```
  
```{r example-tar_import_and_process_spectra}
tar_import_and_process_spectra()
```
  
```{r tests-tar_import_and_process_spectra}
test_that("tar_import_and_process_spectra works", {
  expect_true(inherits(tar_import_and_process_spectra, "function")) 
})
```
  

```{r development-inflate, eval=FALSE}
# Run but keep eval=FALSE to avoid infinite loop
# Execute in the console directly
fusen::inflate(flat_file = "dev/maldipickr-workflow-with-targets.Rmd",
               vignette_name = "maldipickr Workflow with {targets}")
```

